<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>P2P Мессенджер</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    input, button, textarea { width: 100%; padding: 8px; margin: 5px 0; }
    .message { margin-bottom: 8px; }
    .you { color: green; }
    .peer { color: blue; }
  </style>
</head>
<body>
  <h2>P2P Мессенджер</h2>
  <div id="registerSection">
    <input type="text" id="username" placeholder="Ваш логин">
    <input type="text" id="displayName" placeholder="Ваше имя">
    <input type="text" id="avatar" placeholder="URL аватарки (по желанию)">
    <button onclick="registerUser()">Зарегистрироваться</button>
  </div>
  
  <div id="chatSection" style="display:none;">
    <p><b>Ваш Peer ID:</b> <span id="myId"></span></p>
    <input type="text" id="connectId" placeholder="ID друга для подключения">
    <button onclick="connectToPeer()">Подключиться</button>
    
    <div id="chat"></div>
    <textarea id="messageInput" placeholder="Введите сообщение..."></textarea>
    <button onclick="sendMessage()">Отправить</button>
  </div>
  
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer;
    let conn;

    function registerUser() {
      const username = document.getElementById('username').value;
      const displayName = document.getElementById('displayName').value;
      const avatar = document.getElementById('avatar').value;
      if (!username || !displayName) {
        alert('Заполните логин и имя!');
        return;
      }
      const userData = { username, displayName, avatar };
      localStorage.setItem('userData', JSON.stringify(userData));
      initPeer();
    }

    function initPeer() {
      peer = new Peer();
      peer.on('open', id => {
        document.getElementById('myId').innerText = id;
        document.getElementById('registerSection').style.display = 'none';
        document.getElementById('chatSection').style.display = 'block';
      });

      peer.on('connection', connection => {
        conn = connection;
        conn.on('data', data => displayMessage(data, 'peer'));
      });
    }

    function connectToPeer() {
      const peerId = document.getElementById('connectId').value;
      conn = peer.connect(peerId);
      conn.on('open', () => console.log('Соединение открыто с ' + peerId));
      conn.on('data', data => displayMessage(data, 'peer'));
    }

    function sendMessage() {
      const msg = document.getElementById('messageInput').value;
      if (conn && conn.open) {
        conn.send(msg);
        displayMessage(msg, 'you');
        document.getElementById('messageInput').value = '';
      } else {
        alert('Нет соединения с пирами!');
      }
    }

    function displayMessage(msg, sender) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = 'message ' + sender;
      div.innerText = sender === 'you' ? 'Вы: ' + msg : 'Друг: ' + msg;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    window.onload = function() {
      const saved = localStorage.getItem('userData');
      if (saved) initPeer();
    }
  </script>
</body>
</html>
