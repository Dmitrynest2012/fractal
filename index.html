<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>P2P Мессенджер с Списком Друзей</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; display: flex; }
    #friendList { width: 200px; border-right: 1px solid #ccc; padding-right: 10px; }
    #chatArea { flex-grow: 1; padding-left: 10px; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    input, button, textarea { width: 100%; padding: 8px; margin: 5px 0; }
    .message { margin-bottom: 8px; }
    .you { color: green; }
    .peer { color: blue; }
    .friend-item { cursor: pointer; margin-bottom: 5px; }
    .friend-item:hover { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <div id="friendList">
    <h3>Друзья</h3>
    <div id="friends"></div>
    <input type="text" id="friendId" placeholder="Peer ID друга">
    <button onclick="addFriend()">Добавить друга</button>
  </div>

  <div id="chatArea">
    <h2>P2P Мессенджер</h2>
    <div id="registerSection">
      <input type="text" id="username" placeholder="Ваш логин">
      <input type="text" id="displayName" placeholder="Ваше имя">
      <input type="text" id="avatar" placeholder="URL аватарки (по желанию)">
      <button onclick="registerUser()">Зарегистрироваться</button>
    </div>

    <div id="chatSection" style="display:none;">
      <p><b>Ваш Peer ID:</b> <span id="myId"></span></p>
      <div id="chat"></div>
      <textarea id="messageInput" placeholder="Введите сообщение..."></textarea>
      <button onclick="sendMessage()">Отправить</button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer;
    let conn;
    let currentChat = null;
    let friends = JSON.parse(localStorage.getItem('friends') || '[]');

    function saveFriends() {
      localStorage.setItem('friends', JSON.stringify(friends));
      renderFriends();
    }

    function renderFriends() {
      const container = document.getElementById('friends');
      container.innerHTML = '';
      friends.forEach(f => {
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.innerText = f.displayName + ' (' + f.username + ')';
        div.onclick = () => startChat(f);
        container.appendChild(div);
      });
    }

    function registerUser() {
      const username = document.getElementById('username').value;
      const displayName = document.getElementById('displayName').value;
      const avatar = document.getElementById('avatar').value;
      if (!username || !displayName) {
        alert('Заполните логин и имя!');
        return;
      }
      const userData = { username, displayName, avatar };
      localStorage.setItem('userData', JSON.stringify(userData));
      initPeer();
    }

    function initPeer() {
      peer = new Peer();
      peer.on('open', id => {
        document.getElementById('myId').innerText = id;
        document.getElementById('registerSection').style.display = 'none';
        document.getElementById('chatSection').style.display = 'block';
        notifyFriendsAboutNewId(id);
      });

      peer.on('connection', connection => {
        connection.on('data', data => {
          if (data.type === 'msg') {
            displayMessage(data.text, 'peer');
          } else if (data.type === 'id-update') {
            updateFriendId(data.username, connection.peer);
          }
        });
      });
    }

    function notifyFriendsAboutNewId(newId) {
      friends.forEach(f => {
        const c = peer.connect(f.peerId);
        c.on('open', () => {
          c.send({ type: 'id-update', username: JSON.parse(localStorage.getItem('userData')).username });
        });
      });
    }

    function updateFriendId(username, newId) {
      const friend = friends.find(f => f.username === username);
      if (friend) {
        friend.peerId = newId;
        saveFriends();
      }
    }

    function addFriend() {
      const peerId = document.getElementById('friendId').value;
      if (!peerId) return;

      const c = peer.connect(peerId);
      c.on('open', () => {
        c.send({ type: 'request-info' });
      });
      c.on('data', data => {
        if (data.type === 'user-info') {
          friends.push({ username: data.username, displayName: data.displayName, peerId });
          saveFriends();
          alert('Друг добавлен: ' + data.displayName);
        }
      });

      peer.on('connection', incoming => {
        incoming.on('data', data => {
          if (data.type === 'request-info') {
            const user = JSON.parse(localStorage.getItem('userData'));
            incoming.send({ type: 'user-info', username: user.username, displayName: user.displayName });
          }
        });
      });
    }

    function startChat(friend) {
      conn = peer.connect(friend.peerId);
      conn.on('open', () => {
        currentChat = friend;
        document.getElementById('chat').innerHTML = '';
        console.log('Чат с ' + friend.displayName);
      });
      conn.on('data', data => {
        if (data.type === 'msg') displayMessage(data.text, 'peer');
      });
    }

    function sendMessage() {
      const msg = document.getElementById('messageInput').value;
      if (conn && conn.open) {
        conn.send({ type: 'msg', text: msg });
        displayMessage(msg, 'you');
        document.getElementById('messageInput').value = '';
      } else {
        alert('Нет активного соединения!');
      }
    }

    function displayMessage(msg, sender) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = 'message ' + sender;
      div.innerText = sender === 'you' ? 'Вы: ' + msg : 'Друг: ' + msg;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    window.onload = function() {
      const saved = localStorage.getItem('userData');
      if (saved) initPeer();
      renderFriends();
    }
  </script>
</body>
</html>
